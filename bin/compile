#!/bin/sh
# bin/compile BUILD_DIR CACHE_DIR ENV_DIR

set -u # stop on unset variables
set -e # stop on error

CACHE_DIR="${2:-}"
EMSDK_DIR="$CACHE_DIR/emsdk"
EMSDK="${EMSDK_DIR}/emsdk"


REPO=https://github.com/emscripten-core/emsdk

echo "-----> Installing Emscripten"
echo "CACHE_DIR = $CACHE_DIR"
echo "EMSDK_DIR = $EMSDK_DIR"
echo "EMSDK = $EMSDK"

echo "Clonning Emscripten from the repo $REPO"
if [ ! -d "$EMSDK_DIR" ]; then
	git clone "$REPO" "$EMSDK_DIR"
fi

echo "Install latest"
"$EMSDK" install latest
echo "Activate latest"
"$EMSDK" activate latest

if [ $NODE_ENV = production ]; then
	echo "Copy environment"
	cp "$EMSDK_DIR/emsdk_env.sh" ~/.profile.d/
fi
